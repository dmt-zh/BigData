## Техническая инфраструктура

<img src="https://github.com/dmt-zh/BigData/blob/main/DataPipeline/static/de_pipeline.jpg"/>

В качестве технической инфраструктуры будут использованы следующие инструменты. 

- Озеро данных на базе S3
- Аналитическое хранилище на базе Greenplum
- Оркестратор потоков данных - Airflow
- Кластер распределенных вычислений Spark (Kubernetes)
- GitLab для хранения исходного кода

<hr>

## Итоговый вид DAG
Ниже представлен итоговый вид DAG'a, который у нас получиться.

Понадобятся следующие операторы и сенсоры:
- `airflow.operators.empty.EmptyOperator` - для объединения задач
- `airflow.providers.cncf.kubernetes.operators.spark_kubernetes.SparkKubernetesOperator` - для отправки Spark задач на кластер
- `airflow.providers.cncf.kubernetes.sensors.spark_kubernetes.SparkKubernetesSensor` - для отслеживания статуса Spark задач
- `airflow.providers.common.sql.operators.sql.SQLExecuteQueryOperator` - для выполнения запросов к Greenplum

<img src="https://github.com/dmt-zh/BigData/blob/main/DataPipeline/static/full_pipeline.jpg"/>

<hr>

## Описание данных

В проекте будyт использованы данные, предоставляемые из [Теста TPC-H](https://www.tpc.org/tpch/).

Исходные данные, размещены в S3 бакете.

TPC-H - это стандартный бенчмарк для тестирования производительности систем управления реляционными базами данных (RDBMS). Он состоит из набора запросов, которые используются для оценки производительности обработки запросов на чтение больших объемов данных из базы данных.

Набор таблиц, используемых в тесте, включает в себя следующие таблицы:

| **Таблица** | **Описание**                             |
| ----------- | ---------------------------------------- |
| customer    | информация о заказчиках                  |
| lineitem    | информация о позициях в заказах          |
| nation      | информация о нациях/странах              |
| orders      | информация о заказах                     |
| parts       | информация о деталях/запчастях           |
| partsupp    | информация о поставках деталей/запчастей |
| region      | информация о регионах                    |
| supplier    | информация о поставщиках                 |

Каждая из этих таблиц содержит различные поля, описывающие соответствующие сущности. Таблицы взаимосвязаны и связаны между собой по ключевым полям, таким образом, что можно выполнять сложные запросы, которые связывают данные из нескольких таблиц.

<img src="https://github.com/dmt-zh/BigData/blob/main/DataPipeline/static/data_scheme.jpg"/>

<hr>

## Пайплаин Озера Данных (Data Lake)

Необходимо создать pipeline обработки данных (DAG Airflow), который реализует все запросы из последующих шагов:
- построить отчет по данным о позициях в заказе (lineitems), содержащий сводную информацию по позициям каждого заказа, когда-либо совершенного в системе, группировать данные необходимо по идентификатору заказа; сортировка по ключу заказа на возрастание
- построить отчет по данным о заказах (orders), содержащий сводную информацию по заказам в разрезе месяца, страны откуда был отправлен заказ, а также приоритета выполняемого заказа; сортировка по названию страны и приоритета заказа на возрастание
- построить отчет по данным о клиентах (customers), содержащий сводную информацию по заказам в разрезе страны, откуда был отправлен заказ, а также приоритета выполняемого заказа; сортировка по названию страны (N_NAME) и приоритету заказа (C_MKTSEGMENT) на возрастание
- построить отчет по данным о поставщиках (suppliers), содержащий сводную информацию в разрезе страны и региона поставщика;  сортировка по названию страны (N_NAME) и региону (R_NAME) на возрастание
- построить отчет по данным о грузоперевозках (part), содержащий сводную информацию в разрезе страны поставки (N_NAME), типу поставки (P_TYPE) и типу контейнера (P_CONTAINER); сортировка по названию страны (N_NAME) , типу поставки (P_TYPE) и типу контейнера (P_CONTAINER) на возрастание.

<hr>

## Пайплаин витрин DWH

Необходимо расширить созданный ранее pipeline обработки данных (DAG Airflow), который реализует все запросы для создания витрины в Greenplum хранилище над отчетами в S3.

Добавить шаг в DAG Airflow для создания внешней таблицы над отчетом LineItems; таблица должна называться lineitems_report. Формат витрины:

| **Поле**        | **Тип (GP)** | **Описание**                                                                                                          |
| --------------- | ------------ | --------------------------------------------------------------------------------------------------------------------- |
| L_ORDERKEY      | BIGINT       | уникальный идентификатор заказа                                                                                       |
| count           | BIGINT       | число позиций/вещей в заказе                                                                                          |
| sum_extendprice | FLOAT8       | сумма заказа (сумма всех позиций по L_EXTENDEDPRICE)                                                                  |
| mean_discount   | FLOAT8       | медиана скидок по позициям (L_DISCOUNT)                                                                               |
| mean_tax        | FLOAT8       | средний налог в заказе между позициями                                                                                |
| delivery_days   | FLOAT8       | среднее время доставки всех позиций заказа (в днях) с момента заказа (L_RECEIPTDATE) до момента доставки (L_SHIPDATE) |
| A_return_flags  | BIGINT       | количество заказов с флагом L_RETURNFLAG == 'A'                                                                       |
| R_return_flags  | BIGINT       | количество заказов с флагом L_RETURNFLAG == 'R'                                                                       |
| N_return_flags  | BIGINT       | количество заказов с флагом L_RETURNFLAG == 'N'                                                                       |

---

Добавить шаг в DAG Airflow для создания внешней таблицы над отчетом Orders; таблица должна называться orders_report. Формат витрины:

| **Поле**        | **Тип (GP)** | **Описание**                                       |
| --------------- | ------------ | -------------------------------------------------- |
| O_MONTH         | TEXT         | год и месяц заказа (O_ORDERDATE) в формате YYYY-MM |
| N_NAME          | TEXT         | название страны заказа                             |
| O_ORDERPRIORITY | TEXT         | приоритет заказа (O_ORDERPRIORITY)                 |
| orders_count    | BIGINT       | число заказов                                      |
| avg_order_price | FLOAT8       | средняя цена в заказе (O_TOTALPRICE)               |
| sum_order_price | FLOAT8       | сумма заказов (O_TOTALPRICE)                       |
| min_order_price | FLOAT8       | минимальная цена в заказе (O_TOTALPRICE)           |
| max_order_price | FLOAT8       | максимальная цена в заказе (O_TOTALPRICE)          |
| f_order_status  | BIGINT       | количество заказов с флагом O_ORDERSTATUS == 'F'   |
| o_order_status  | BIGINT       | количество заказов с флагом O_ORDERSTATUS == 'O'   |
| p_order_status  | BIGINT       | количество заказов с флагом O_ORDERSTATUS == 'P'   |

---

Добавить шаг в DAG Airflow для создания внешней таблицы над отчетом Customers; таблица должна называться customers_report. Формат витрины:

| **Поле**               | **Тип (GP)** | **Описание**                             |
| ---------------------- | ------------ | ---------------------------------------- |
| R_NAME                 | TEXT         | название региона                         |
| N_NAME                 | TEXT         | название страны                          |
| C_MKTSEGMENT           | TEXT         | маркетинговый сегмент                    |
| unique_customers_count | BIGINT       | число уникальных заказов                 |
| avg_acctbal            | FLOAT8       | средний остаток клиента (C_ACCTBAL)      |
| mean_acctbal           | FLOAT8       | медианный остаток клиента (C_ACCTBAL)    |
| min_acctbal            | FLOAT8       | минимальный остаток клиента (C_ACCTBAL)  |
| max_acctbal            | FLOAT8       | максимальный остаток клиента (C_ACCTBAL) |

---

Добавить шаг в DAG Airflow для создания внешней таблицы над отчетом Suppliers; таблица должна называться suppliers_report. Формат витрины:

| **Поле**              | **Тип (GP)** | **Описание**                                            |
| --------------------- | ------------ | ------------------------------------------------------- |
| R_NAME                | TEXT         | название региона                                        |
| N_NAME                | TEXT         | название страны                                         |
| unique_supplers_count | BIGINT       | число уникальных поставщиков в разрезе страны и региона |
| avg_acctbal           | FLOAT8       | средний остаток поставщика (S_ACCTBAL)                  |
| mean_acctbal          | FLOAT8       | медианный остаток поставщика (S_ACCTBAL)                |
| min_acctbal           | FLOAT8       | минимальный остаток поставщика (S_ACCTBAL)              |
| max_acctbal           | FLOAT8       | максимальный остаток поставщика (S_ACCTBAL)             |

---

Добавить шаг в DAG Airflow для создания внешней таблицы над отчетом Part; таблица должна называться parts_report. Формат витрины:

| **Поле**         | **Тип (GP)** | **Описание**                                    |
| ---------------- | ------------ | ----------------------------------------------- |
| N_NAME           | TEXT         | название региона                                |
| P_TYPE           | TEXT         | название страны                                 |
| P_CONTAINER      | TEXT         | тип контейнера                                  |
| parts_count      | BIGINT       | число поставок                                  |
| avg_retailprice  | FLOAT8       | средняя розничная цена (P_RETAILPRICE)          |
| size             | BIGINT       | суммарный размер (P_SIZE)                       |
| mean_retailprice | FLOAT8       | медианная розничная цена(P_RETAILPRICE)         |
| min_retailprice  | FLOAT8       | минимальная розничная цена(P_RETAILPRICE)       |
| max_retailprice  | FLOAT8       | максимальная розничная цена(P_RETAILPRICE)      |
| avg_supplycost   | FLOAT8       | средняя стоимость поставки (PS_SUPPLYCOST)      |
| mean_supplycost  | FLOAT8       | медианная стоимость поставки (PS_SUPPLYCOST)    |
| min_supplycost   | FLOAT8       | минимальная стоимость поставки (PS_SUPPLYCOST)  |
| max_supplycost   | FLOAT8       | максимальная стоимость поставки (PS_SUPPLYCOST) |

